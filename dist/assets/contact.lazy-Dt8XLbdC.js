import{r as u,j as e,D as X,z as R,A as w,E as V,aM as I,I as y,B as b,J as d,H as L,ag as U,ah as q,ai as O,aN as z,aO as F,aP as S,aQ as C,aR as T,c0 as D,aS as E,c as A}from"./index-DFSfWVwN.js";import{p as P,C as B}from"./profile.service-CpCIw-bN.js";function H({isOpen:s,onClose:m,type:p,identifier:n,field:h,value:i,onSuccess:v}){const[x,t]=u.useState(""),[c,l]=u.useState(!1),j=async a=>{var r,f;a.preventDefault(),l(!0);try{(await P.verifyOtp({field:h,value:i,otp:x})).data.success&&(d.success("OTP verified successfully"),v(),m())}catch(g){const N=g;d.error(((f=(r=N.response)==null?void 0:r.data)==null?void 0:f.message)||"Failed to verify OTP")}finally{l(!1)}},o=async()=>{var a,r;try{l(!0),(await P.resendOtp(n)).data.success&&d.success("OTP resent successfully")}catch(f){const g=f;d.error(((r=(a=g.response)==null?void 0:a.data)==null?void 0:r.message)||"Failed to resend OTP")}finally{l(!1)}};return e.jsx(X,{open:s,onOpenChange:m,children:e.jsxs(R,{children:[e.jsxs(w,{children:[e.jsx(V,{children:"Verify OTP"}),e.jsxs(I,{children:["An OTP has been sent to your ",p,": ",n,". Please enter the OTP below to verify."]})]}),e.jsxs("form",{onSubmit:j,className:"space-y-4",children:[e.jsx(y,{type:"text",placeholder:"Enter OTP",value:x,onChange:a=>t(a.target.value),disabled:c}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(b,{type:"button",variant:"outline",onClick:o,disabled:c,children:"Resend OTP"}),e.jsx(b,{type:"submit",disabled:c,children:"Verify OTP"})]})]})]})})}const M=O.object({email:O.string().email({message:"Please enter a valid email."}).optional(),phone:O.string().regex(/^\+91\d{10}$/,{message:"Phone number must be in the format +91XXXXXXXXXX"})});function Q(){const{user:s}=L(),[m,p]=u.useState(!1),[n,h]=u.useState(null),i=U({resolver:q(M),defaultValues:{email:(s==null?void 0:s.email)??"",phone:(s==null?void 0:s.phone)??""},mode:"onChange"});u.useEffect(()=>{s&&(i.reset({email:s.email??"",phone:s.phone??""}),p(!1))},[s,i]);const v=()=>{h(null)},x=async t=>{var c,l,j;try{if(p(!0),t.email!==(s==null?void 0:s.email)||t.phone!==(s==null?void 0:s.phone)){const o=t.email!==(s==null?void 0:s.email)?"email":"phone",a=o==="email"?t.email:t.phone;if(a){const r=await P.requestUpdate({updates:{[o]:a},type:"OTP_REQUIRED"});r.data.success&&((c=r.data.data)!=null&&c.requiresOtp)&&h({isOpen:!0,type:o,identifier:a,field:o,value:a,onSuccess:v})}}else d.info("No changes detected")}catch(o){const a=o;d.error(((j=(l=a.response)==null?void 0:l.data)==null?void 0:j.message)||"Failed to initiate update")}finally{p(!1)}};return e.jsxs(e.Fragment,{children:[n&&e.jsx(H,{isOpen:n.isOpen,onClose:()=>h(null),type:n.type,identifier:n.identifier,field:n.field,value:n.value,onSuccess:n.onSuccess}),m?e.jsx("div",{className:"text-center text-muted-foreground",children:"Loading contact details..."}):e.jsx(z,{...i,children:e.jsxs("form",{id:"contact-form",onSubmit:i.handleSubmit(x),className:"space-y-8",children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2",children:[e.jsx(F,{control:i.control,name:"email",render:({field:t})=>e.jsxs(S,{children:[e.jsx(C,{children:"Email"}),e.jsx(T,{children:e.jsx(y,{type:"email",...t})}),e.jsxs(D,{children:[s!=null&&s.emailVerified?"Email is verified":"Email is not verified",e.jsx("br",{}),"Changing email requires OTP verification and admin approval"]}),e.jsx(E,{})]})}),e.jsx(F,{control:i.control,name:"phone",render:({field:t})=>e.jsxs(S,{children:[e.jsx(C,{children:"Phone Number"}),e.jsx(T,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{value:"+91",disabled:!0,className:"w-16"}),e.jsx(y,{...t})]})}),e.jsxs(D,{children:[s!=null&&s.phoneVerified?"Phone is verified":"Phone is not verified",e.jsx("br",{}),"Changing phone number requires OTP verification and admin approval"]}),e.jsx(E,{})]})})]}),e.jsx(b,{type:"submit",disabled:m,children:"Update contact details"})]})})]})}function k(){return e.jsx(B,{title:"Contact Information",desc:"Update your contact details and communication preferences.",children:e.jsx(Q,{})})}const $=A("/dashboard/profile/contact")({component:k});export{$ as Route};
